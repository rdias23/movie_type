<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Movie type</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.13.1/application.js' type='text/javascript'></script>
    <link href='./assets/0.13.1/application.css' media='screen, projection, print' rel='stylesheet' type='text/css' />
    <link rel="icon" type="image/png" href="./assets/0.13.1/favicon_red.png" />
  </head>

  <body data-branch-coverage=true>
    <div id="loading">
      <img src="./assets/0.13.1/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" class="hide">
      <div class="timestamp">Generated <abbr class="timeago" title="2025-04-30T19:53:05-04:00">2025-04-30T19:53:05-04:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent">
      <span class="red">
  58.53%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         5.34
       </span>
    </span> hits/line
    )
  </h2>

  <a name="AllFiles"></a>

  <div>
    <b>15</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>340</b> relevant lines,
    <span class="green"><b>199</b> lines covered</span> and
    <span class="red"><b>141</b> lines missed. </span>
    (<span class="red">
  58.53%
</span>
)
  </div>

  
    <div class="t-branch-summary">
      <span><b>34</b> total branches, </span>
      <span class="green"><b>29</b> branches covered</span> and
      <span class="red"><b>5</b> branches missed.</span>
      (<span class="yellow">
  85.29%
</span>
)
    </div>
  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
            <th class="cell--number">Branch Coverage</th>
            <th class="cell--number">Branches</th>
            <th class="cell--number">Covered branches</th>
            <th class="cell--number">Missed branches </th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f6e9a3f87d654125b622ac1d2b791b586a232c60" class="src_link" title="app/channels/application_cable/channel.rb">app/channels/application_cable/channel.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a44673a2a30fe78e63802ffb2e7d1a890e170801" class="src_link" title="app/channels/application_cable/connection.rb">app/channels/application_cable/connection.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e9bebf47bbc94ed3594f3fe5803c9e476bf09da5" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">15</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#00e1e041144ce42331663b00ba739c2d72321f36" class="src_link" title="app/controllers/quiz_controller.rb">app/controllers/quiz_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">130</td>
            <td class="cell--number">95</td>
            <td class="cell--number">0</td>
            <td class="cell--number">95</td>
            <td class="cell--number">0.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#7c3237b1412ef1e8c1721cd0cfd78f95a0657a8d" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2230eb63bef3ab5fb1236d3aae0677e4d4b7c421" class="src_link" title="app/jobs/application_job.rb">app/jobs/application_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#1f2cb8d94814f4bc2ad744cdf143e7992ab2891a" class="src_link" title="app/mailers/application_mailer.rb">app/mailers/application_mailer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a9c1c542f0e32da66e2a4f43d6a33c75da51e1b4" class="src_link" title="app/mailers/quiz_mailer.rb">app/mailers/quiz_mailer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">15</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#77cfd12765fdfcb1946ff8b0dbc010096676eff2" class="src_link" title="app/models/application_record.rb">app/models/application_record.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">3</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#9cf62c0f47a516eebc22ead3468da4fcbfc393de" class="src_link" title="app/models/personality_dimension.rb">app/models/personality_dimension.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">17</td>
            <td class="cell--number">17</td>
            <td class="cell--number">0</td>
            <td class="cell--number">6.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">2</td>
              <td class="cell--number">2</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4eb821c3e816bafd6571165c9824aa6f0b192bdb" class="src_link" title="app/models/quiz_question.rb">app/models/quiz_question.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">23</td>
            <td class="cell--number">8</td>
            <td class="cell--number">8</td>
            <td class="cell--number">0</td>
            <td class="cell--number">18.00</td>
            
              <td class="red strong cell--number t-file__branch-coverage">50.00 %</td>
              <td class="cell--number">2</td>
              <td class="cell--number">1</td>
              <td class="cell--number">1</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b4e3dc489f1825d23e8f2e99229bd53a5aa4a833" class="src_link" title="app/models/user_response.rb">app/models/user_response.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">41</td>
            <td class="cell--number">15</td>
            <td class="cell--number">15</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4.60</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">2</td>
              <td class="cell--number">2</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#84a502b6f523e5b6a4275d7c4a1170877eeaf683" class="src_link" title="app/presenters/result_presenter.rb">app/presenters/result_presenter.rb</a></td>
            <td class="green strong cell--number t-file__coverage">93.42 %</td>
            <td class="cell--number">148</td>
            <td class="cell--number">76</td>
            <td class="cell--number">71</td>
            <td class="cell--number">5</td>
            <td class="cell--number">14.79</td>
            
              <td class="red strong cell--number t-file__branch-coverage">80.00 %</td>
              <td class="cell--number">10</td>
              <td class="cell--number">8</td>
              <td class="cell--number">2</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ef35ebe7fa01bb346c6d1ce5482aec3c8c4febb0" class="src_link" title="app/services/openai_service.rb">app/services/openai_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">96.39 %</td>
            <td class="cell--number">243</td>
            <td class="cell--number">83</td>
            <td class="cell--number">80</td>
            <td class="cell--number">3</td>
            <td class="cell--number">3.92</td>
            
              <td class="yellow strong cell--number t-file__branch-coverage">88.89 %</td>
              <td class="cell--number">18</td>
              <td class="cell--number">16</td>
              <td class="cell--number">2</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#71c07dc550a0a6c68c351f4a3deda23f16fc83df" class="src_link" title="app/services/personality_archetype_service.rb">app/services/personality_archetype_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">45</td>
            <td class="cell--number">5</td>
            <td class="cell--number">5</td>
            <td class="cell--number">0</td>
            <td class="cell--number">9.40</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>


        
          <div class="file_list_container" id="Controllers">
  <h2>
    <span class="group_name">Controllers</span>
    (<span class="covered_percent">
      <span class="red">
  0.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Controllers"></a>

  <div>
    <b>2</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>105</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>105</b> lines missed. </span>
    (<span class="red">
  0.0%
</span>
)
  </div>

  
    <div class="t-branch-summary">
      <span><b>0</b> total branches, </span>
      <span class="green"><b>0</b> branches covered</span> and
      <span class="red"><b>0</b> branches missed.</span>
      (<span class="green">
  100.0%
</span>
)
    </div>
  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
            <th class="cell--number">Branch Coverage</th>
            <th class="cell--number">Branches</th>
            <th class="cell--number">Covered branches</th>
            <th class="cell--number">Missed branches </th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#e9bebf47bbc94ed3594f3fe5803c9e476bf09da5" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">15</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0</td>
            <td class="cell--number">10</td>
            <td class="cell--number">0.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#00e1e041144ce42331663b00ba739c2d72321f36" class="src_link" title="app/controllers/quiz_controller.rb">app/controllers/quiz_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">130</td>
            <td class="cell--number">95</td>
            <td class="cell--number">0</td>
            <td class="cell--number">95</td>
            <td class="cell--number">0.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Channels">
  <h2>
    <span class="group_name">Channels</span>
    (<span class="covered_percent">
      <span class="red">
  0.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Channels"></a>

  <div>
    <b>2</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>8</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>8</b> lines missed. </span>
    (<span class="red">
  0.0%
</span>
)
  </div>

  
    <div class="t-branch-summary">
      <span><b>0</b> total branches, </span>
      <span class="green"><b>0</b> branches covered</span> and
      <span class="red"><b>0</b> branches missed.</span>
      (<span class="green">
  100.0%
</span>
)
    </div>
  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
            <th class="cell--number">Branch Coverage</th>
            <th class="cell--number">Branches</th>
            <th class="cell--number">Covered branches</th>
            <th class="cell--number">Missed branches </th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f6e9a3f87d654125b622ac1d2b791b586a232c60" class="src_link" title="app/channels/application_cable/channel.rb">app/channels/application_cable/channel.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a44673a2a30fe78e63802ffb2e7d1a890e170801" class="src_link" title="app/channels/application_cable/connection.rb">app/channels/application_cable/connection.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Models">
  <h2>
    <span class="group_name">Models</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         7.55
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Models"></a>

  <div>
    <b>4</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>42</b> relevant lines,
    <span class="green"><b>42</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  
    <div class="t-branch-summary">
      <span><b>6</b> total branches, </span>
      <span class="green"><b>5</b> branches covered</span> and
      <span class="red"><b>1</b> branches missed.</span>
      (<span class="yellow">
  83.33%
</span>
)
    </div>
  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
            <th class="cell--number">Branch Coverage</th>
            <th class="cell--number">Branches</th>
            <th class="cell--number">Covered branches</th>
            <th class="cell--number">Missed branches </th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#77cfd12765fdfcb1946ff8b0dbc010096676eff2" class="src_link" title="app/models/application_record.rb">app/models/application_record.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">3</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#9cf62c0f47a516eebc22ead3468da4fcbfc393de" class="src_link" title="app/models/personality_dimension.rb">app/models/personality_dimension.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">17</td>
            <td class="cell--number">17</td>
            <td class="cell--number">0</td>
            <td class="cell--number">6.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">2</td>
              <td class="cell--number">2</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#4eb821c3e816bafd6571165c9824aa6f0b192bdb" class="src_link" title="app/models/quiz_question.rb">app/models/quiz_question.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">23</td>
            <td class="cell--number">8</td>
            <td class="cell--number">8</td>
            <td class="cell--number">0</td>
            <td class="cell--number">18.00</td>
            
              <td class="red strong cell--number t-file__branch-coverage">50.00 %</td>
              <td class="cell--number">2</td>
              <td class="cell--number">1</td>
              <td class="cell--number">1</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b4e3dc489f1825d23e8f2e99229bd53a5aa4a833" class="src_link" title="app/models/user_response.rb">app/models/user_response.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">41</td>
            <td class="cell--number">15</td>
            <td class="cell--number">15</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4.60</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">2</td>
              <td class="cell--number">2</td>
              <td class="cell--number">0</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Mailers">
  <h2>
    <span class="group_name">Mailers</span>
    (<span class="covered_percent">
      <span class="red">
  0.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Mailers"></a>

  <div>
    <b>2</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>18</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>18</b> lines missed. </span>
    (<span class="red">
  0.0%
</span>
)
  </div>

  
    <div class="t-branch-summary">
      <span><b>0</b> total branches, </span>
      <span class="green"><b>0</b> branches covered</span> and
      <span class="red"><b>0</b> branches missed.</span>
      (<span class="green">
  100.0%
</span>
)
    </div>
  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
            <th class="cell--number">Branch Coverage</th>
            <th class="cell--number">Branches</th>
            <th class="cell--number">Covered branches</th>
            <th class="cell--number">Missed branches </th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#1f2cb8d94814f4bc2ad744cdf143e7992ab2891a" class="src_link" title="app/mailers/application_mailer.rb">app/mailers/application_mailer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a9c1c542f0e32da66e2a4f43d6a33c75da51e1b4" class="src_link" title="app/mailers/quiz_mailer.rb">app/mailers/quiz_mailer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">15</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Helpers">
  <h2>
    <span class="group_name">Helpers</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="yellow">
         1.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Helpers"></a>

  <div>
    <b>1</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>1</b> relevant lines,
    <span class="green"><b>1</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  
    <div class="t-branch-summary">
      <span><b>0</b> total branches, </span>
      <span class="green"><b>0</b> branches covered</span> and
      <span class="red"><b>0</b> branches missed.</span>
      (<span class="green">
  100.0%
</span>
)
    </div>
  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
            <th class="cell--number">Branch Coverage</th>
            <th class="cell--number">Branches</th>
            <th class="cell--number">Covered branches</th>
            <th class="cell--number">Missed branches </th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#7c3237b1412ef1e8c1721cd0cfd78f95a0657a8d" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Jobs">
  <h2>
    <span class="group_name">Jobs</span>
    (<span class="covered_percent">
      <span class="red">
  0.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Jobs"></a>

  <div>
    <b>1</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>2</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>2</b> lines missed. </span>
    (<span class="red">
  0.0%
</span>
)
  </div>

  
    <div class="t-branch-summary">
      <span><b>0</b> total branches, </span>
      <span class="green"><b>0</b> branches covered</span> and
      <span class="red"><b>0</b> branches missed.</span>
      (<span class="green">
  100.0%
</span>
)
    </div>
  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
            <th class="cell--number">Branch Coverage</th>
            <th class="cell--number">Branches</th>
            <th class="cell--number">Covered branches</th>
            <th class="cell--number">Missed branches </th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2230eb63bef3ab5fb1236d3aae0677e4d4b7c421" class="src_link" title="app/jobs/application_job.rb">app/jobs/application_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0.00</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Libraries">
  <h2>
    <span class="group_name">Libraries</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Libraries"></a>

  <div>
    <b>0</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>0</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  
    <div class="t-branch-summary">
      <span><b>0</b> total branches, </span>
      <span class="green"><b>0</b> branches covered</span> and
      <span class="red"><b>0</b> branches missed.</span>
      (<span class="green">
  100.0%
</span>
)
    </div>
  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
            <th class="cell--number">Branch Coverage</th>
            <th class="cell--number">Branches</th>
            <th class="cell--number">Covered branches</th>
            <th class="cell--number">Missed branches </th>
          
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Ungrouped">
  <h2>
    <span class="group_name">Ungrouped</span>
    (<span class="covered_percent">
      <span class="green">
  95.12%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         9.12
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Ungrouped"></a>

  <div>
    <b>3</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>164</b> relevant lines,
    <span class="green"><b>156</b> lines covered</span> and
    <span class="red"><b>8</b> lines missed. </span>
    (<span class="green">
  95.12%
</span>
)
  </div>

  
    <div class="t-branch-summary">
      <span><b>28</b> total branches, </span>
      <span class="green"><b>24</b> branches covered</span> and
      <span class="red"><b>4</b> branches missed.</span>
      (<span class="yellow">
  85.71%
</span>
)
    </div>
  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
            <th class="cell--number">Branch Coverage</th>
            <th class="cell--number">Branches</th>
            <th class="cell--number">Covered branches</th>
            <th class="cell--number">Missed branches </th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#84a502b6f523e5b6a4275d7c4a1170877eeaf683" class="src_link" title="app/presenters/result_presenter.rb">app/presenters/result_presenter.rb</a></td>
            <td class="green strong cell--number t-file__coverage">93.42 %</td>
            <td class="cell--number">148</td>
            <td class="cell--number">76</td>
            <td class="cell--number">71</td>
            <td class="cell--number">5</td>
            <td class="cell--number">14.79</td>
            
              <td class="red strong cell--number t-file__branch-coverage">80.00 %</td>
              <td class="cell--number">10</td>
              <td class="cell--number">8</td>
              <td class="cell--number">2</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ef35ebe7fa01bb346c6d1ce5482aec3c8c4febb0" class="src_link" title="app/services/openai_service.rb">app/services/openai_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">96.39 %</td>
            <td class="cell--number">243</td>
            <td class="cell--number">83</td>
            <td class="cell--number">80</td>
            <td class="cell--number">3</td>
            <td class="cell--number">3.92</td>
            
              <td class="yellow strong cell--number t-file__branch-coverage">88.89 %</td>
              <td class="cell--number">18</td>
              <td class="cell--number">16</td>
              <td class="cell--number">2</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#71c07dc550a0a6c68c351f4a3deda23f16fc83df" class="src_link" title="app/services/personality_archetype_service.rb">app/services/personality_archetype_service.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">45</td>
            <td class="cell--number">5</td>
            <td class="cell--number">5</td>
            <td class="cell--number">0</td>
            <td class="cell--number">9.40</td>
            
              <td class="green strong cell--number t-file__branch-coverage">100.00 %</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
              <td class="cell--number">0</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
      </div>

      <div id="footer">
        Generated by <a href="https://github.com/simplecov-ruby/simplecov">simplecov</a> v0.21.2
        and simplecov-html v0.13.1<br/>
        using RSpec
      </div>

      <div class="source_files">
      
        <div class="source_table" id="f6e9a3f87d654125b622ac1d2b791b586a232c60">
  <div class="header">
    <h3>app/channels/application_cable/channel.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>4</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>0</b> total branches, </span>
          <span class="green"><b>0</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            
              
            

            <code class="ruby">module ApplicationCable</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            
              
            

            <code class="ruby">  class Channel &lt; ActionCable::Channel::Base</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a44673a2a30fe78e63802ffb2e7d1a890e170801">
  <div class="header">
    <h3>app/channels/application_cable/connection.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>4</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>0</b> total branches, </span>
          <span class="green"><b>0</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            
              
            

            <code class="ruby">module ApplicationCable</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            
              
            

            <code class="ruby">  class Connection &lt; ActionCable::Connection::Base</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e9bebf47bbc94ed3594f3fe5803c9e476bf09da5">
  <div class="header">
    <h3>app/controllers/application_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>10</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>10</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>0</b> total branches, </span>
          <span class="green"><b>0</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            
              
            

            <code class="ruby">class ApplicationController &lt; ActionController::Base</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby">  # Only allow modern browsers supporting webp images, web push, badges, import maps, CSS nesting, and CSS :has.</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            
              
            

            <code class="ruby">  allow_browser versions: :modern</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            
              
            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            
              
            

            <code class="ruby">  protect_from_forgery with: :exception</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            
              
            

            <code class="ruby">  skip_forgery_protection if: -&gt; { request.format.json? }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            
              
            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            
              
            

            <code class="ruby">  before_action :set_csrf_cookie</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            
              
            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            
              
            

            <code class="ruby">  def set_csrf_cookie</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            
              
            

            <code class="ruby">    cookies[&#39;CSRF-TOKEN&#39;] = form_authenticity_token</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="00e1e041144ce42331663b00ba739c2d72321f36">
  <div class="header">
    <h3>app/controllers/quiz_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>95</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>95</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>0</b> total branches, </span>
          <span class="green"><b>0</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            
              
            

            <code class="ruby">class QuizController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            
              
            

            <code class="ruby">  def start</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            
              
            

            <code class="ruby">    # Always clear session state when starting a new quiz</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            
              
            

            <code class="ruby">    session[:user_email] = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            
              
            

            <code class="ruby">    session[:responses] = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            
              
            

            <code class="ruby">  def question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            
              
            

            <code class="ruby">    @current_question = QuizQuestion.find(params[:id])</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            
              
            

            <code class="ruby">    @total_questions = QuizQuestion.count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            
              
            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            
              
            

            <code class="ruby">    # Calculate the current question number (1-based) by ordering all questions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            
              
            

            <code class="ruby">    @current_question_number = QuizQuestion.where(&quot;id &lt;= ?&quot;, @current_question.id).count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            
              
            

            <code class="ruby">    @progress = ((@current_question_number / @total_questions.to_f) * 100).round</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            
              
            

            <code class="ruby">    # Initialize or preserve the session</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            
              
            

            <code class="ruby">    if params[:email].present?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            
              
            

            <code class="ruby">      session[:user_email] = params[:email]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            
              
            

            <code class="ruby">      session[:responses] = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            
              
            

            <code class="ruby">      # Always clear old responses for this email when starting a new quiz</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            
              
            

            <code class="ruby">      UserResponse.where(user_email: params[:email]).delete_all</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="22">
            

            
              
            

            <code class="ruby">    elsif !session[:user_email] &amp;&amp; request.referrer&amp;.include?(&#39;quiz/question&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            
              
            

            <code class="ruby">      # If user hit back and session was lost, redirect to start</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            
              
            

            <code class="ruby">      redirect_to quiz_start_path, alert: &quot;Please start the quiz again&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            
              
            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            
              
            

            <code class="ruby">    # Ensure we have an email before proceeding</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            
              
            

            <code class="ruby">    unless session[:user_email]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            
              
            

            <code class="ruby">      redirect_to quiz_start_path, alert: &quot;Please enter your email to start the quiz&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            
              
            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            
              
            

            <code class="ruby">  def answer</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            
              
            

            <code class="ruby">    # Ensure we have an email</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            
              
            

            <code class="ruby">    unless session[:user_email]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            
              
            

            <code class="ruby">      redirect_to quiz_start_path, alert: &quot;Please enter your email to start the quiz&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            
              
            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            
              
            

            <code class="ruby">    Rails.logger.info &quot;Answer params: #{params.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            
              
            

            <code class="ruby">    Rails.logger.info &quot;Session: #{session.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            
              
            

            <code class="ruby">    # Save the response</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            
              
            

            <code class="ruby">    response = UserResponse.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            
              
            

            <code class="ruby">      user_email: session[:user_email],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            
              
            

            <code class="ruby">      quiz_question_id: params[:question_id],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            
              
            

            <code class="ruby">      response_value: params[:value]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="50">
            

            
              
            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            
              
            

            <code class="ruby">    Rails.logger.info &quot;Created response: #{response.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            
              
            

            <code class="ruby">    # Store in session for backup</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            
              
            

            <code class="ruby">    session[:responses] ||= []</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            
              
            

            <code class="ruby">    session[:responses] &lt;&lt; {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            
              
            

            <code class="ruby">      question_id: params[:question_id],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="58">
            

            
              
            

            <code class="ruby">      value: params[:value]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            
              
            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            
              
            

            <code class="ruby">    # Get the next question, ensuring we get questions from all dimensions</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="62">
            

            
              
            

            <code class="ruby">    answered_questions = UserResponse.where(user_email: session[:user_email]).pluck(:quiz_question_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            
              
            

            <code class="ruby">    current_question = QuizQuestion.find(params[:question_id])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            
              
            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            
              
            

            <code class="ruby">    # First try to get another question from the same dimension</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            
              
            

            <code class="ruby">    next_question = QuizQuestion</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            
              
            

            <code class="ruby">      .where(personality_dimension_id: current_question.personality_dimension_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="68">
            

            
              
            

            <code class="ruby">      .where.not(id: answered_questions)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            
              
            

            <code class="ruby">      .order(:id)  # Important: Get questions in order within dimension</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            
              
            

            <code class="ruby">      .first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            
              
            

            <code class="ruby">    # If no more questions in this dimension, move to the next dimension</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            
              
            

            <code class="ruby">    unless next_question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            
              
            

            <code class="ruby">      next_dimension = PersonalityDimension</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            
              
            

            <code class="ruby">        .joins(:quiz_questions)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            
              
            

            <code class="ruby">        .where.not(quiz_questions: { id: answered_questions })</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            
              
            

            <code class="ruby">        .first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            
              
            

            <code class="ruby">      if next_dimension</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            
              
            

            <code class="ruby">        # Get the first unanswered question from this dimension</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            
              
            

            <code class="ruby">        next_question = QuizQuestion</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            
              
            

            <code class="ruby">          .where(personality_dimension_id: next_dimension.id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="83">
            

            
              
            

            <code class="ruby">          .where.not(id: answered_questions)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            
              
            

            <code class="ruby">          .order(:id)  # Important: Get questions in order within dimension</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            
              
            

            <code class="ruby">          .first</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="86">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            
              
            

            <code class="ruby">    Rails.logger.info &quot;Next question: #{next_question.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            
              
            

            <code class="ruby">    if next_question</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            
              
            

            <code class="ruby">      redirect_to quiz_question_path(next_question)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="93">
            

            
              
            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            
              
            

            <code class="ruby">      redirect_to quiz_result_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            
              
            

            <code class="ruby">  rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            
              
            

            <code class="ruby">    Rails.logger.error &quot;Error in answer action: #{e.message}\n#{e.backtrace.join(&quot;\n&quot;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            
              
            

            <code class="ruby">    flash[:error] = &quot;Something went wrong. Please try again.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            
              
            

            <code class="ruby">    redirect_to root_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            
              
            

            <code class="ruby">  def result</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="103">
            

            
              
            

            <code class="ruby">    unless session[:user_email]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            
              
            

            <code class="ruby">      redirect_to quiz_start_path, alert: &quot;Please enter your email to start the quiz&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="105">
            

            
              
            

            <code class="ruby">      return</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="108">
            

            
              
            

            <code class="ruby">    @presenter = ResultPresenter.new(session[:user_email])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            
              
            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            
              
            

            <code class="ruby">    # Send the results email with just the data, not the presenter object</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            
              
            

            <code class="ruby">    email_data = {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            
              
            

            <code class="ruby">      movie_type: @presenter.movie_type,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="113">
            

            
              
            

            <code class="ruby">      personality_description: @presenter.personality_description,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            
              
            

            <code class="ruby">      recommendations: @presenter.recommendations,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            
              
            

            <code class="ruby">      quote: @presenter.quote,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            
              
            

            <code class="ruby">      quote_attribution: @presenter.quote_attribution,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="117">
            

            
              
            

            <code class="ruby">      dimension_breakdowns: @presenter.dimension_breakdowns</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            
              
            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="119">
            

            
              
            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            
              
            

            <code class="ruby">    QuizMailer.results_email(session[:user_email], email_data).deliver_later</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            
              
            

            <code class="ruby">    # Clear session after showing results</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            
              
            

            <code class="ruby">    session[:user_email] = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="124">
            

            
              
            

            <code class="ruby">    session[:responses] = nil</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            
              
            

            <code class="ruby">  rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            
              
            

            <code class="ruby">    Rails.logger.error(&quot;Error generating results: #{e.message}\n#{e.backtrace.join(&quot;\n&quot;)}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            
              
            

            <code class="ruby">    flash[:error] = &quot;We encountered an error generating your results. Please try again.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            
              
            

            <code class="ruby">    redirect_to root_path</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7c3237b1412ef1e8c1721cd0cfd78f95a0657a8d">
  <div class="header">
    <h3>app/helpers/application_helper.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>1</b> relevant lines.
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>0</b> total branches, </span>
          <span class="green"><b>0</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">module ApplicationHelper</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2230eb63bef3ab5fb1236d3aae0677e4d4b7c421">
  <div class="header">
    <h3>app/jobs/application_job.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>0</b> total branches, </span>
          <span class="green"><b>0</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            
              
            

            <code class="ruby">class ApplicationJob &lt; ActiveJob::Base</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby">  # Automatically retry jobs that encountered a deadlock</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            
              
            

            <code class="ruby">  # retry_on ActiveRecord::Deadlocked</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            
              
            

            <code class="ruby">  # Most jobs are safe to ignore if the underlying records are no longer available</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            
              
            

            <code class="ruby">  # discard_on ActiveJob::DeserializationError</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1f2cb8d94814f4bc2ad744cdf143e7992ab2891a">
  <div class="header">
    <h3>app/mailers/application_mailer.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>4</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>0</b> total branches, </span>
          <span class="green"><b>0</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            
              
            

            <code class="ruby">class ApplicationMailer &lt; ActionMailer::Base</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            
              
            

            <code class="ruby">  default from: &quot;from@example.com&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            
              
            

            <code class="ruby">  layout &quot;mailer&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a9c1c542f0e32da66e2a4f43d6a33c75da51e1b4">
  <div class="header">
    <h3>app/mailers/quiz_mailer.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>14</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>0</b> total branches, </span>
          <span class="green"><b>0</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            
              
            

            <code class="ruby">class QuizMailer &lt; ApplicationMailer</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            
              
            

            <code class="ruby">  def results_email(user_email, data)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            
              
            

            <code class="ruby">    @movie_type = data[:movie_type]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            
              
            

            <code class="ruby">    @personality_description = data[:personality_description]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            
              
            

            <code class="ruby">    @recommendations = data[:recommendations]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            
              
            

            <code class="ruby">    @quote = data[:quote]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="7">
            

            
              
            

            <code class="ruby">    @quote_attribution = data[:quote_attribution]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            
              
            

            <code class="ruby">    @dimension_breakdowns = data[:dimension_breakdowns]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            
              
            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            
              
            

            <code class="ruby">    mail(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            
              
            

            <code class="ruby">      to: user_email,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            
              
            

            <code class="ruby">      subject: &quot;Your Movie Type Results: #{@movie_type}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            
              
            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="77cfd12765fdfcb1946ff8b0dbc010096676eff2">
  <div class="header">
    <h3>app/models/application_record.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>0</b> total branches, </span>
          <span class="green"><b>0</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">class ApplicationRecord &lt; ActiveRecord::Base</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  primary_abstract_class</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9cf62c0f47a516eebc22ead3468da4fcbfc393de">
  <div class="header">
    <h3>app/models/personality_dimension.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>17</b> relevant lines.
      <span class="green"><b>17</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>2</b> total branches, </span>
          <span class="green"><b>2</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">class PersonalityDimension &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  has_many :quiz_questions</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  validates :name, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  validates :high_label, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  validates :low_label, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def letter_for_score(normalized_score)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="9">
            
              <span class="hits">20</span>
            

            
              
            

            <code class="ruby">    self.class.score_to_letter(normalized_score, high_label, low_label)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def self.score_to_letter(normalized_score, high_label, low_label)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            
              
            

            <code class="ruby">    # A score of -1.0 means strongly prefer first option (high_label)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            
              
            

            <code class="ruby">    # A score of 0.0 means neutral between options (default to high_label)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            
              
            

            <code class="ruby">    # A score of 1.0 means strongly prefer second option (low_label)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="38" data-linenumber="16">
            
              <span class="hits">38</span>
            

            
              
                <span class="hits" title="then branch hit 17 times">
                  then: 17
                </span>
              
                <span class="hits" title="else branch hit 21 times">
                  else: 21
                </span>
              
            

            <code class="ruby">    normalized_score &gt;= 0.5 ? low_label[0].upcase : high_label[0].upcase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="19">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def calculate_letter(responses)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="20">
            
              <span class="hits">12</span>
            

            
              
            

            <code class="ruby">    normalized_scores = responses.map { |r| r.quiz_question.normalize_response(r.response_value) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="21">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">    avg_normalized = normalized_scores.sum / normalized_scores.length</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="22">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">    Rails.logger.info(&quot;Dimension #{name}:&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="23">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">    Rails.logger.info(&quot;  Responses: #{responses.map(&amp;:response_value)}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="24">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">    Rails.logger.info(&quot;  Normalized: #{normalized_scores}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="25">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">    Rails.logger.info(&quot;  Average: #{avg_normalized}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="26">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">    letter_for_score(avg_normalized)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="4eb821c3e816bafd6571165c9824aa6f0b192bdb">
  <div class="header">
    <h3>app/models/quiz_question.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="red">
  50.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>8</b> relevant lines.
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>2</b> total branches, </span>
          <span class="green"><b>1</b> branches covered</span> and
          <span class="red"><b>1</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">class QuizQuestion &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  belongs_to :personality_dimension</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  has_many :user_responses, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  validates :prompt, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="6">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  validates :high_text, :low_text, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            
              
            

            <code class="ruby">  # Convert a user&#39;s response (typically 1-5) to a normalized score (-1.0 to 1.0)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            
              
            

            <code class="ruby">  # 1 = Strongly prefer first option (high_text) -&gt; becomes -1.0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            
              
            

            <code class="ruby">  # 3 = Neutral -&gt; becomes 0.0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            
              
            

            <code class="ruby">  # 5 = Strongly prefer second option (low_text) -&gt; becomes 1.0</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def normalize_response(response_value)</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="69" data-linenumber="13">
            
              <span class="hits">69</span>
            

            
              
                <span class="hits" title="else branch hit 69 times">
                  else: 69
                </span>
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
            

            <code class="ruby">    return 0 unless response_value.between?(1, 5)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            
              
            

            <code class="ruby">    # Normalize to -1.0 to 1.0 range</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            
              
            

            <code class="ruby">    # This maps:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            
              
            

            <code class="ruby">    # 1 -&gt; -1.0 (strong high preference)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            
              
            

            <code class="ruby">    # 2 -&gt; -0.5</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            
              
            

            <code class="ruby">    # 3 -&gt; 0.0 (neutral)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            
              
            

            <code class="ruby">    # 4 -&gt; 0.5</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            
              
            

            <code class="ruby">    # 5 -&gt; 1.0 (strong low preference)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="69" data-linenumber="21">
            
              <span class="hits">69</span>
            

            
              
            

            <code class="ruby">    (response_value - 3) / 2.0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b4e3dc489f1825d23e8f2e99229bd53a5aa4a833">
  <div class="header">
    <h3>app/models/user_response.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>15</b> relevant lines.
      <span class="green"><b>15</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>2</b> total branches, </span>
          <span class="green"><b>2</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">class UserResponse &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  belongs_to :quiz_question</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  validates :user_email, presence: true, format: { with: URI::MailTo::EMAIL_REGEXP }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  validates :response_value, presence: true, inclusion: { in: 1..5 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            
              
            

            <code class="ruby">  </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            
              
            

            <code class="ruby">  # Get the normalized score for this response (-1.0 to 1.0)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def normalized_score</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="9">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">    quiz_question.normalize_response(response_value)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            
              
            

            <code class="ruby">  # Class method to calculate a user&#39;s complete movie personality type</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="13">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def self.calculate_type(user_email)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="14">
            
              <span class="hits">10</span>
            

            
              
                <span class="hits" title="else branch hit 7 times">
                  else: 7
                </span>
              
                <span class="hits" title="then branch hit 3 times">
                  then: 3
                </span>
              
            

            <code class="ruby">    return nil unless user_email.present?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            
              
            

            <code class="ruby">    # Group responses by personality dimension and calculate average scores</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="17">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">    dimension_scores = joins(quiz_question: :personality_dimension)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            
              
            

            <code class="ruby">      .where(user_email: user_email)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            
              
            

            <code class="ruby">      .group(&#39;personality_dimensions.id&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            
              
            

            <code class="ruby">      .select(&#39;personality_dimensions.*, AVG(user_responses.response_value - 3) as avg_score&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            
              
            

            <code class="ruby">      .order(&#39;personality_dimensions.id&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            
              
            

            <code class="ruby">    # Convert scores to letters using PersonalityDimension&#39;s score_to_letter method</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="24">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">    dimension_scores.map do |result|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="10" data-linenumber="25">
            
              <span class="hits">10</span>
            

            
              
            

            <code class="ruby">      PersonalityDimension.score_to_letter(result.avg_score, result.high_label, result.low_label)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            
              
            

            <code class="ruby">    end.join</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            
              
            

            <code class="ruby">  # Safe method to view user email for debugging</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="30">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def self.debug_responses_for_email(email)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="31">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">    Rails.logger.info &quot;DEBUGGING: Viewing responses for #{email}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="32">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">    where(user_email: email).includes(:quiz_question).order(:created_at).map do |response|</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            
              
            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="9" data-linenumber="34">
            
              <span class="hits">9</span>
            

            
              
            

            <code class="ruby">        email: response.user_email,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            
              
            

            <code class="ruby">        question_id: response.quiz_question_id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            
              
            

            <code class="ruby">        value: response.response_value,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            
              
            

            <code class="ruby">        created_at: response.created_at</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            
              
            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="84a502b6f523e5b6a4275d7c4a1170877eeaf683">
  <div class="header">
    <h3>app/presenters/result_presenter.rb</h3>
    <h4>
      <span class="green">
  93.42%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="red">
  80.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>76</b> relevant lines.
      <span class="green"><b>71</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>10</b> total branches, </span>
          <span class="green"><b>8</b> branches covered</span> and
          <span class="red"><b>2</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">class ResultPresenter</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  attr_reader :user_email, :movie_type, :personality_description, :recommendations, :archetype_title, :quote, :quote_attribution</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def initialize(user_email)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="5">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">    @user_email = user_email</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="6">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">    calculate_results</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="7">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">    set_random_quote</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def calculate_results</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="11">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">    @movie_type = calculate_movie_type</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="12">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">    archetype = PersonalityArchetypeService.get_archetype(@movie_type)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="13">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">    @archetype_title = archetype[:title]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            
              
            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            
              
            

            <code class="ruby">    # Fallback descriptions if OpenAI is not configured</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="16">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">    Rails.logger.info &quot;OPENAI_API_KEY present?: #{ENV[&#39;OPENAI_API_KEY&#39;].present?}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            
              
            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            
              
            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="8" data-linenumber="19">
            
              <span class="hits">8</span>
            

            
              
                <span class="hits" title="then branch hit 8 times">
                  then: 8
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">      if ENV[&#39;OPENAI_API_KEY&#39;].present?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="20">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">        openai = OpenaiService.new</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="21">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">        Rails.logger.info &quot;OpenAI service initialized&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            
              
            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="23">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">        @personality_description = openai.generate_personality_description(@movie_type)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="24">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        Rails.logger.info &quot;Got personality description: #{@personality_description}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            
              
            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="26">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        @recommendations = openai.generate_recommendations(@movie_type, user_responses)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="7" data-linenumber="27">
            
              <span class="hits">7</span>
            

            
              
            

            <code class="ruby">        Rails.logger.info &quot;Got recommendations: #{@recommendations.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="29">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="30">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      Rails.logger.error &quot;Error using OpenAI: #{e.message}\n#{e.backtrace.join(&quot;\n&quot;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      Rails.logger.info &quot;Falling back to default content...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="32">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      @personality_description = generate_fallback_description</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="33">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      @recommendations = generate_fallback_recommendations</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="37">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def dimension_breakdowns</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="38">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    PersonalityDimension.all.map do |dimension|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="20" data-linenumber="39">
            
              <span class="hits">20</span>
            

            
              
            

            <code class="ruby">      dimension_responses = user_responses.select { |r| r.quiz_question.personality_dimension_id == dimension.id }</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="4" data-linenumber="40">
            
              <span class="hits">4</span>
            

            
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 4 times">
                  else: 4
                </span>
              
            

            <code class="ruby">      next nil if dimension_responses.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            
              
            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="42">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">      normalized_scores = dimension_responses.map { |r| r.quiz_question.normalize_response(r.response_value) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="43">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      avg_normalized = normalized_scores.sum / normalized_scores.length</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="44">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">      letter = dimension.letter_for_score(avg_normalized)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            
              
            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            
              
            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="47">
            
              <span class="hits">4</span>
            

            
              
            

            <code class="ruby">        name: dimension.name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            
              
            

            <code class="ruby">        letter: letter,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            
              
            

            <code class="ruby">        high_label: dimension.high_label,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            
              
            

            <code class="ruby">        low_label: dimension.low_label,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            
              
            

            <code class="ruby">        leans_high: letter == dimension.high_label[0].upcase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            
              
            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            
              
            

            <code class="ruby">    end.compact</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            
              
            

            <code class="ruby">  rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            
              
            

            <code class="ruby">    Rails.logger.error(&quot;Error in dimension_breakdowns: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            
              
            

            <code class="ruby">    []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="59">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="61">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def generate_fallback_description</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="62">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">    archetype = PersonalityArchetypeService.get_archetype(@movie_type)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="63">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">    archetype[:description]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="66">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def generate_fallback_recommendations</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            
              
            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="68">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      films: [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            
              
            

            <code class="ruby">        &quot;2001: A Space Odyssey&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            
              
            

            <code class="ruby">        &quot;The Godfather&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            
              
            

            <code class="ruby">        &quot;Pulp Fiction&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            
              
            

            <code class="ruby">        &quot;Amlie&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            
              
            

            <code class="ruby">        &quot;Seven Samurai&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            
              
            

            <code class="ruby">      ],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            
              
            

            <code class="ruby">      directors: [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            
              
            

            <code class="ruby">        &quot;Stanley Kubrick&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            
              
            

            <code class="ruby">        &quot;Martin Scorsese&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            
              
            

            <code class="ruby">        &quot;Akira Kurosawa&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            
              
            

            <code class="ruby">        &quot;Wong Kar-wai&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            
              
            

            <code class="ruby">        &quot;Christopher Nolan&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            
              
            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            
              
            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="85">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def calculate_movie_type</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            
              
            

            <code class="ruby">    # Get all responses for this user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="87">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">    responses = user_responses</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            
              
            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            
              
            

            <code class="ruby">    # Group responses by dimension and calculate letters</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="90">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">    type_letters = PersonalityDimension.all.map do |dimension|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="149" data-linenumber="91">
            
              <span class="hits">149</span>
            

            
              
            

            <code class="ruby">      dimension_responses = responses.select { |r| r.quiz_question.personality_dimension_id == dimension.id }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            
              
            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            
              
            

            <code class="ruby">      # If no responses for this dimension, use a neutral score (0)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="33" data-linenumber="94">
            
              <span class="hits">33</span>
            

            
              
                <span class="hits" title="then branch hit 5 times">
                  then: 5
                </span>
              
            

            <code class="ruby">      if dimension_responses.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="95">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        Rails.logger.info(&quot;\nNo responses for dimension #{dimension.name}, using neutral score&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="96">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        letter = dimension.letter_for_score(0)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="97">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        Rails.logger.info(&quot;  Letter: #{letter}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="98">
            
              <span class="hits">5</span>
            

            
              
            

            <code class="ruby">        letter</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            
              
            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            
              
                <span class="hits" title="else branch hit 28 times">
                  else: 28
                </span>
              
            

            <code class="ruby">        # Calculate normalized scores</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="56" data-linenumber="101">
            
              <span class="hits">56</span>
            

            
              
            

            <code class="ruby">        normalized_scores = dimension_responses.map { |r| r.quiz_question.normalize_response(r.response_value) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="102">
            
              <span class="hits">28</span>
            

            
              
            

            <code class="ruby">        avg_normalized = normalized_scores.sum / normalized_scores.length</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            
              
            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="104">
            
              <span class="hits">28</span>
            

            
              
            

            <code class="ruby">        Rails.logger.info(&quot;\nCalculating letter for dimension #{dimension.name}:&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="105">
            
              <span class="hits">28</span>
            

            
              
            

            <code class="ruby">        Rails.logger.info(&quot;  Raw responses: #{dimension_responses.map(&amp;:response_value)}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="106">
            
              <span class="hits">28</span>
            

            
              
            

            <code class="ruby">        Rails.logger.info(&quot;  Normalized scores: #{normalized_scores}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="107">
            
              <span class="hits">28</span>
            

            
              
            

            <code class="ruby">        Rails.logger.info(&quot;  Average normalized: #{avg_normalized}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            
              
            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="109">
            
              <span class="hits">28</span>
            

            
              
            

            <code class="ruby">        letter = dimension.letter_for_score(avg_normalized)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="110">
            
              <span class="hits">28</span>
            

            
              
            

            <code class="ruby">        Rails.logger.info(&quot;  Letter: #{letter}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="28" data-linenumber="111">
            
              <span class="hits">28</span>
            

            
              
            

            <code class="ruby">        letter</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="115">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">    type_letters.join</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="118">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def user_responses</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="54" data-linenumber="119">
            
              <span class="hits">54</span>
            

            
              
            

            <code class="ruby">    @user_responses ||= UserResponse.includes(quiz_question: :personality_dimension)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="120">
            

            
              
            

            <code class="ruby">                                  .where(user_email: user_email)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="122">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="123">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def set_random_quote</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="124">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">    preferences = PersonalityDimension.all.map do |d|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="33" data-linenumber="125">
            
              <span class="hits">33</span>
            

            
              
                <span class="hits" title="then branch hit 14 times">
                  then: 14
                </span>
              
                <span class="hits" title="else branch hit 19 times">
                  else: 19
                </span>
              
            

            <code class="ruby">      label = d.letter_for_score(calculate_dimension_score(d)) == d.high_label[0].upcase ? d.high_label : d.low_label</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="33" data-linenumber="126">
            
              <span class="hits">33</span>
            

            
              
            

            <code class="ruby">      &quot;#{d.name}: #{label}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            
              
            

            <code class="ruby">    end.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            
              
            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="130">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">      response = OpenaiService.new.generate_quote_for_type(movie_type, preferences)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="131">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">      result = JSON.parse(response)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="132">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">      @quote = result[&quot;quote&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="8" data-linenumber="133">
            
              <span class="hits">8</span>
            

            
              
            

            <code class="ruby">      @quote_attribution = result[&quot;attribution&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            
              
            

            <code class="ruby">    rescue =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="135">
            

            
              
            

            <code class="ruby">      Rails.logger.error(&quot;Error generating quote: #{e.message}&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            
              
            

            <code class="ruby">      @quote = &quot;Every story is unique, just like every viewer.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            
              
            

            <code class="ruby">      @quote_attribution = &quot;Movie Type&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="141">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def calculate_dimension_score(dimension)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="159" data-linenumber="142">
            
              <span class="hits">159</span>
            

            
              
            

            <code class="ruby">    responses = user_responses.select { |r| r.quiz_question.personality_dimension_id == dimension.id }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="35" data-linenumber="143">
            
              <span class="hits">35</span>
            

            
              
                <span class="hits" title="then branch hit 6 times">
                  then: 6
                </span>
              
                <span class="hits" title="else branch hit 29 times">
                  else: 29
                </span>
              
            

            <code class="ruby">    return 0 if responses.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            
              
            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="58" data-linenumber="145">
            
              <span class="hits">58</span>
            

            
              
            

            <code class="ruby">    scores = responses.map { |r| r.quiz_question.normalize_response(r.response_value) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="29" data-linenumber="146">
            
              <span class="hits">29</span>
            

            
              
            

            <code class="ruby">    scores.sum / scores.length</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ef35ebe7fa01bb346c6d1ce5482aec3c8c4febb0">
  <div class="header">
    <h3>app/services/openai_service.rb</h3>
    <h4>
      <span class="green">
  96.39%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="yellow">
  88.89%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>83</b> relevant lines.
      <span class="green"><b>80</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>18</b> total branches, </span>
          <span class="green"><b>16</b> branches covered</span> and
          <span class="red"><b>2</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require &#39;openai&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">require &#39;json&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">class OpenaiService</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def initialize</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="45" data-linenumber="6">
            
              <span class="hits">45</span>
            

            
              
                <span class="hits" title="then branch hit 45 times">
                  then: 45
                </span>
              
                <span class="hits" title="else branch hit 0 times">
                  else: 0
                </span>
              
            

            <code class="ruby">    puts &quot;Initializing OpenAI service with key: #{ENV[&#39;OPENAI_API_KEY&#39;].present? ? &#39;present&#39; : &#39;missing&#39;}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="45" data-linenumber="7">
            
              <span class="hits">45</span>
            

            
              
            

            <code class="ruby">    @client = OpenAI::Client.new(access_token: ENV.fetch(&#39;OPENAI_API_KEY&#39;))</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def generate_personality_description(movie_type)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="11">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">    puts &quot;Generating personality description for type: #{movie_type}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            
              
            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="13">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">    system_prompt = &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            
              
            

            <code class="ruby">      You are a poetic film critic with deep knowledge of cinema. Your task is to create an engaging, </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            
              
            

            <code class="ruby">      insightful description of someone&#39;s movie-watching personality based on their 4-letter type.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            
              
            

            <code class="ruby">      The type consists of 4 dimensions:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            
              
            

            <code class="ruby">      1. P/A (Plot vs Atmosphere) - How they engage with narrative</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            
              
            

            <code class="ruby">      2. W/G (Whimsy vs Gravitas) - Their preferred emotional tone</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            
              
            

            <code class="ruby">      3. E/I (External vs Internal) - Their viewing perspective</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            
              
            

            <code class="ruby">      4. X/M (eXplicit vs aMbiguous) - Their interpretive approach</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            
              
            

            <code class="ruby">      So, a complete type might be something like PGEX AGIM</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            
              
            

            <code class="ruby">      Write a 2-3 paragraph response that:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            
              
            

            <code class="ruby">      - Captures the essence of their cinematic personality</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            
              
            

            <code class="ruby">      - Uses elegant, poetic language</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            
              
            

            <code class="ruby">      - References their specific preferences without being too literal</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            
              
            

            <code class="ruby">      - Maintains a sophisticated, Criterion Collection-worthy tone</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            
              
            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            
              
            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="33">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      response = @client.chat(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            
              
            

            <code class="ruby">        parameters: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            
              
            

            <code class="ruby">          model: ENV.fetch(&quot;OPENAI_MODEL&quot;, &quot;gpt-4&quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            
              
            

            <code class="ruby">          messages: [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            
              
            

            <code class="ruby">            { role: &#39;system&#39;, content: system_prompt },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            
              
            

            <code class="ruby">            { role: &#39;user&#39;, content: &quot;Generate a personality description for movie type: #{movie_type}&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            
              
            

            <code class="ruby">          ],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            
              
            

            <code class="ruby">          temperature: 0.7</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            
              
            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="43">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      puts &quot;OpenAI response: #{response.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="44">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      response.dig(&#39;choices&#39;, 0, &#39;message&#39;, &#39;content&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="45">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="46">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      puts &quot;OpenAI error in generate_personality_description: #{e.message}\n#{e.backtrace.join(&quot;\n&quot;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="47">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      raise</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="51">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def generate_recommendations(movie_type, responses)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="52">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">    puts &quot;\n\n=== GENERATING RECOMMENDATIONS ===\n&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="53">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">    puts &quot;Movie type: #{movie_type}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            
              
            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            
              
            

            <code class="ruby">    # Calculate average scores for context</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="56">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">    dimension_scores = responses.group_by { |r| r.quiz_question.personality_dimension }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="57">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">                               .transform_values { |rs| rs.sum(&amp;:response_value) / rs.size.to_f }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            
              
            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="59">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">    puts &quot;Dimension scores: #{dimension_scores.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="61">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">    system_prompt = &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            
              
            

            <code class="ruby">      You are a knowledgeable film curator with expertise across all genres and eras of cinema. </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            
              
            

            <code class="ruby">      Based on the user&#39;s movie personality type and preferences, generate personalized film and director recommendations.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            
              
            

            <code class="ruby">      The type #{movie_type} indicates these preferences:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            
              
            

            <code class="ruby">      #{format_dimension_preferences(dimension_scores)}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            
              
            

            <code class="ruby">      Return your response in this exact JSON format (no additional text or explanations):</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            
              
            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            
              
            

            <code class="ruby">        &quot;films&quot;: [&quot;Film 1&quot;, &quot;Film 2&quot;, &quot;Film 3&quot;, &quot;Film 4&quot;, &quot;Film 5&quot;],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            
              
            

            <code class="ruby">        &quot;directors&quot;: [&quot;Director 1&quot;, &quot;Director 2&quot;, &quot;Director 3&quot;, &quot;Director 4&quot;, &quot;Director 5&quot;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            
              
            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            
              
            

            <code class="ruby">      Choose films and directors that match their preferences. Include both classics and lesser-known works.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            
              
            

            <code class="ruby">      Focus on critically acclaimed choices that align with their personality type.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            
              
            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="78">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">    puts &quot;\nSystem prompt:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="79">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">    puts system_prompt</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            
              
            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="82">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      puts &quot;\nCalling OpenAI API...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="83">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">      response = @client.chat(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            
              
            

            <code class="ruby">        parameters: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            
              
            

            <code class="ruby">          model: ENV.fetch(&quot;OPENAI_MODEL&quot;, &quot;gpt-4&quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            
              
            

            <code class="ruby">          messages: [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            
              
            

            <code class="ruby">            { role: &#39;system&#39;, content: system_prompt },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            
              
            

            <code class="ruby">            { role: &#39;user&#39;, content: &quot;Generate recommendations for type: #{movie_type}&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            
              
            

            <code class="ruby">          ],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            
              
            

            <code class="ruby">          temperature: 0.7</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            
              
            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="93">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      puts &quot;\nOpenAI API Response:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="94">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      puts response.inspect</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            
              
            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            
              
            

            <code class="ruby">      # Parse the JSON response</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="97">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      content = response.dig(&#39;choices&#39;, 0, &#39;message&#39;, &#39;content&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="98">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      puts &quot;\nRaw content from OpenAI:&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="99">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      puts content.inspect</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            
              
            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            
              
            

            <code class="ruby">      begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="102">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        puts &quot;\nAttempting to parse JSON...&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="103">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">        recommendations = JSON.parse(content)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="104">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        puts &quot;Parsed recommendations: #{recommendations.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            
              
            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            
              
            

            <code class="ruby">        # Convert string keys to symbols and ensure we have the required keys</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            
              
            

            <code class="ruby">        result = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="108">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">          films: recommendations[&#39;films&#39;] || [],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="109">
            

            
              
            

            <code class="ruby">          directors: recommendations[&#39;directors&#39;] || []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="111">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        puts &quot;\nProcessed result: #{result.inspect}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            
              
            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            
              
            

            <code class="ruby">        # If either array is empty, fall back to defaults</code>
          </li>
        </div>
      
        <div>
          <li class="missed-branch" data-hits="1" data-linenumber="114">
            
              <span class="hits">1</span>
            

            
              
                <span class="hits" title="then branch hit 0 times">
                  then: 0
                </span>
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">        if result[:films].empty? || result[:directors].empty?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="115">
            

            
              
            

            <code class="ruby">          puts &quot;\nMissing required recommendations, falling back to defaults&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            
              
            

            <code class="ruby">          return generate_fallback_recommendations</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            
              
            

            <code class="ruby">        end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            
              
            

            <code class="ruby">        </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="119">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        result</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="120">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      rescue JSON::ParserError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="121">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        puts &quot;\nJSON parse error: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="122">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        puts &quot;Response was: #{content}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="123">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        generate_fallback_recommendations</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="125">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="126">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      puts &quot;\nOpenAI error: #{e.message}\n#{e.backtrace.join(&quot;\n&quot;)}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="127">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      generate_fallback_recommendations</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="128">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="129">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="131">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def generate_quote_for_type(movie_type, preferences)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="132">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">    system_prompt = &lt;&lt;~PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            
              
            

            <code class="ruby">      You are a film expert with deep knowledge of cinema. Generate a meaningful movie quote that reflects </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            
              
            

            <code class="ruby">      this person&#39;s movie-watching personality. The quote can be from a real or imagined film, but it should </code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            
              
            

            <code class="ruby">      deeply resonate with their preferences.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            
              
            

            <code class="ruby">      Their preferences are:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="138">
            

            
              
            

            <code class="ruby">      #{preferences}</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="139">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            
              
            

            <code class="ruby">      Return a JSON response in this exact format:</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            
              
            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            
              
            

            <code class="ruby">        &quot;quote&quot;: &quot;The quote text here&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="143">
            

            
              
            

            <code class="ruby">        &quot;attribution&quot;: &quot;Character or Context, Movie Title&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="144">
            

            
              
            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            
              
            

            <code class="ruby">      The quote should feel authentic and meaningful, capturing the essence of their cinematic taste.</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            
              
            

            <code class="ruby">    PROMPT</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            
              
            

            <code class="ruby">    begin</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="150">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      response = @client.chat(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            
              
            

            <code class="ruby">        parameters: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            
              
            

            <code class="ruby">          model: ENV.fetch(&quot;OPENAI_MODEL&quot;, &quot;gpt-4&quot;),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            
              
            

            <code class="ruby">          messages: [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            
              
            

            <code class="ruby">            { role: &#39;system&#39;, content: system_prompt },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="155">
            

            
              
            

            <code class="ruby">            { role: &#39;user&#39;, content: &quot;Generate a quote for movie type: #{movie_type}&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="156">
            

            
              
            

            <code class="ruby">          ],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="157">
            

            
              
            

            <code class="ruby">          temperature: 0.7,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="158">
            

            
              
            

            <code class="ruby">          response_format: { type: &quot;json_object&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="159">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="160">
            

            
              
            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="161">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      response.dig(&#39;choices&#39;, 0, &#39;message&#39;, &#39;content&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="162">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="163">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      puts &quot;OpenAI error in generate_quote: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="164">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      fallback = { quote: &quot;Every story is unique, just like every viewer.&quot;, attribution: &quot;Movie Type&quot; }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="165">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      fallback.to_json</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="166">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="167">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="168">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="169">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def all_personality_types(force_refresh: false)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            
              
            

            <code class="ruby">    self.class.all_personality_types(force_refresh: force_refresh)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="171">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="172">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="173">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def self.all_personality_types(force_refresh: false)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="174">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">    cache_key = &quot;openai_service/personality_types&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="175">
            

            
              
            

            <code class="ruby">    </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="176">
            
              <span class="hits">3</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">    if force_refresh</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="177">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      Rails.cache.delete(cache_key)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="178">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="179">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="180">
            
              <span class="hits">3</span>
            

            
              
            

            <code class="ruby">    Rails.cache.fetch(cache_key, expires_in: 1.day) do</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="181">
            

            
              
            

            <code class="ruby">      dimensions = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="182">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        narrative: [&#39;P&#39;, &#39;A&#39;],  # Plot vs Atmosphere</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="183">
            

            
              
            

            <code class="ruby">        tone: [&#39;W&#39;, &#39;G&#39;],      # Whimsy vs Gravitas</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="184">
            

            
              
            

            <code class="ruby">        perspective: [&#39;E&#39;, &#39;I&#39;], # External vs Internal</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="185">
            

            
              
            

            <code class="ruby">        interpretation: [&#39;X&#39;, &#39;M&#39;]  # eXplicit vs aMbiguous</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="186">
            

            
              
            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="187">
            

            
              
            

            <code class="ruby">      </code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="188">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      types = dimensions[:narrative].product(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="189">
            

            
              
            

            <code class="ruby">        dimensions[:tone],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="190">
            

            
              
            

            <code class="ruby">        dimensions[:perspective],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="191">
            

            
              
            

            <code class="ruby">        dimensions[:interpretation]</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="192">
            
              <span class="hits">16</span>
            

            
              
            

            <code class="ruby">      ).map { |combo| combo.join }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="193">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="194">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">      types.each_with_object({}) do |type, hash|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="195">
            
              <span class="hits">16</span>
            

            
              
            

            <code class="ruby">        hash[type] = {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="196">
            

            
              
            

            <code class="ruby">          dimensions: {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="197">
            
              <span class="hits">16</span>
            

            
              
                <span class="hits" title="then branch hit 8 times">
                  then: 8
                </span>
              
                <span class="hits" title="else branch hit 8 times">
                  else: 8
                </span>
              
            

            <code class="ruby">            narrative: type[0] == &#39;P&#39; ? &#39;Plot-focused&#39; : &#39;Atmosphere-focused&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="198">
            
              <span class="hits">16</span>
            

            
              
                <span class="hits" title="then branch hit 8 times">
                  then: 8
                </span>
              
                <span class="hits" title="else branch hit 8 times">
                  else: 8
                </span>
              
            

            <code class="ruby">            tone: type[1] == &#39;W&#39; ? &#39;Whimsical&#39; : &#39;Grave&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="199">
            
              <span class="hits">16</span>
            

            
              
                <span class="hits" title="then branch hit 8 times">
                  then: 8
                </span>
              
                <span class="hits" title="else branch hit 8 times">
                  else: 8
                </span>
              
            

            <code class="ruby">            perspective: type[2] == &#39;E&#39; ? &#39;External&#39; : &#39;Internal&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="16" data-linenumber="200">
            
              <span class="hits">16</span>
            

            
              
                <span class="hits" title="then branch hit 8 times">
                  then: 8
                </span>
              
                <span class="hits" title="else branch hit 8 times">
                  else: 8
                </span>
              
            

            <code class="ruby">            interpretation: type[3] == &#39;X&#39; ? &#39;Explicit&#39; : &#39;Ambiguous&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="201">
            

            
              
            

            <code class="ruby">          },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="202">
            

            
              
            

            <code class="ruby">          description: OpenaiService.new.generate_personality_description(type)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="203">
            

            
              
            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="204">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="205">
            

            
              
            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="206">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="207">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="208">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="209">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="210">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def format_dimension_preferences(dimension_scores)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="211">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">    dimension_scores.map do |dimension, score|</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="212">
            
              <span class="hits">6</span>
            

            
              
                <span class="hits" title="then branch hit 4 times">
                  then: 4
                </span>
              
            

            <code class="ruby">      preference = if score &gt; 3</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="213">
            
              <span class="hits">4</span>
            

            
              
                <span class="hits" title="else branch hit 2 times">
                  else: 2
                </span>
              
            

            <code class="ruby">        &quot;Strong preference for #{dimension.high_label}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="214">
            
              <span class="hits">2</span>
            

            
              
                <span class="hits" title="then branch hit 1 times">
                  then: 1
                </span>
              
            

            <code class="ruby">      elsif score &lt; 3</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="215">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        &quot;Strong preference for #{dimension.low_label}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="216">
            

            
              
                <span class="hits" title="else branch hit 1 times">
                  else: 1
                </span>
              
            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="217">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">        &quot;Balanced between #{dimension.high_label} and #{dimension.low_label}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="218">
            

            
              
            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="219">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="6" data-linenumber="220">
            
              <span class="hits">6</span>
            

            
              
            

            <code class="ruby">      &quot;- #{dimension.name}: #{preference}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="221">
            

            
              
            

            <code class="ruby">    end.join(&quot;\n&quot;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="222">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="223">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="224">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def generate_fallback_recommendations</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="225">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">    puts &quot;\nUsing fallback recommendations&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="226">
            

            
              
            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="227">
            
              <span class="hits">2</span>
            

            
              
            

            <code class="ruby">      films: [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="228">
            

            
              
            

            <code class="ruby">        &quot;2001: A Space Odyssey&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="229">
            

            
              
            

            <code class="ruby">        &quot;The Godfather&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="230">
            

            
              
            

            <code class="ruby">        &quot;Pulp Fiction&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="231">
            

            
              
            

            <code class="ruby">        &quot;Amlie&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="232">
            

            
              
            

            <code class="ruby">        &quot;Seven Samurai&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="233">
            

            
              
            

            <code class="ruby">      ],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="234">
            

            
              
            

            <code class="ruby">      directors: [</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="235">
            

            
              
            

            <code class="ruby">        &quot;Stanley Kubrick&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="236">
            

            
              
            

            <code class="ruby">        &quot;Martin Scorsese&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="237">
            

            
              
            

            <code class="ruby">        &quot;Akira Kurosawa&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="238">
            

            
              
            

            <code class="ruby">        &quot;Wong Kar-wai&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="239">
            

            
              
            

            <code class="ruby">        &quot;Christopher Nolan&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="240">
            

            
              
            

            <code class="ruby">      ]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="241">
            

            
              
            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="242">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="243">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="71c07dc550a0a6c68c351f4a3deda23f16fc83df">
  <div class="header">
    <h3>app/services/personality_archetype_service.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    
      <h4>
        <span class="green">
  100.0%
</span>

        branches covered
      </h4>
    

    <div class="t-line-summary">
      <b>5</b> relevant lines.
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    
      <div class="t-branch-summary">
          <span><b>0</b> total branches, </span>
          <span class="green"><b>0</b> branches covered</span> and
          <span class="red"><b>0</b> branches missed.</span>
      </div>
    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">class PersonalityArchetypeService</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            
              
            

            <code class="ruby">  ARCHETYPES = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">    &quot;AGEA&quot; =&gt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            
              
            

            <code class="ruby">      title: &quot;The Visionary Explorer&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            
              
            

            <code class="ruby">      description: &quot;You are drawn to films that push the boundaries of imagination and artistry. Like a cosmic traveler through the cinematic universe, you seek out stories that challenge conventional narratives and embrace experimental storytelling. Your appreciation for both grand artistic visions and emotional authenticity makes you a true connoisseur of transformative cinema.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            
              
            

            <code class="ruby">    },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            
              
            

            <code class="ruby">    &quot;AGEI&quot; =&gt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            
              
            

            <code class="ruby">      title: &quot;The Philosophical Dreamer&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            
              
            

            <code class="ruby">      description: &quot;Cinema is your gateway to deeper understanding. You gravitate towards films that weave complex narratives with profound philosophical undertones. Your analytical mind delights in decoding layered meanings while your heart remains open to the emotional resonance of each story.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            
              
            

            <code class="ruby">    },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            
              
            

            <code class="ruby">    &quot;AGER&quot; =&gt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            
              
            

            <code class="ruby">      title: &quot;The Artistic Realist&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            
              
            

            <code class="ruby">      description: &quot;You find beauty in the raw authenticity of cinema. While appreciating artistic excellence, you connect most deeply with stories that mirror life&#39;s genuine moments. Your viewing style combines a love for aesthetic mastery with an unwavering appreciation for emotional truth.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            
              
            

            <code class="ruby">    },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            
              
            

            <code class="ruby">    &quot;AGIR&quot; =&gt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            
              
            

            <code class="ruby">      title: &quot;The Contemplative Observer&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            
              
            

            <code class="ruby">      description: &quot;Your approach to cinema is both introspective and analytical. You appreciate films that offer deep psychological insights while maintaining artistic integrity. Like a skilled detective of human nature, you uncover hidden meanings in every frame.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            
              
            

            <code class="ruby">    },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            
              
            

            <code class="ruby">    &quot;AGIA&quot; =&gt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            
              
            

            <code class="ruby">      title: &quot;The Aesthetic Adventurer&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            
              
            

            <code class="ruby">      description: &quot;For you, cinema is a journey through visual poetry. You seek out films that combine artistic innovation with immersive storytelling. Your adventurous spirit in film appreciation leads you to discover beauty in both experimental art films and emotionally resonant narratives.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            
              
            

            <code class="ruby">    },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            
              
            

            <code class="ruby">    &quot;RGEA&quot; =&gt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            
              
            

            <code class="ruby">      title: &quot;The Emotional Voyager&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            
              
            

            <code class="ruby">      description: &quot;You navigate the world of cinema through your heart while appreciating its artistic depths. Your connection to films is primarily emotional, yet you have a keen eye for creative excellence. This combination makes every viewing experience a journey of both feeling and aesthetic discovery.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            
              
            

            <code class="ruby">    },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            
              
            

            <code class="ruby">    &quot;RGEI&quot; =&gt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            
              
            

            <code class="ruby">      title: &quot;The Empathetic Analyst&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            
              
            

            <code class="ruby">      description: &quot;Your approach to cinema balances emotional resonance with intellectual curiosity. You are drawn to films that explore the human condition through both heart and mind, finding profound meaning in stories that combine emotional depth with thoughtful analysis.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            
              
            

            <code class="ruby">    },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            
              
            

            <code class="ruby">    &quot;RGER&quot; =&gt; {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            
              
            

            <code class="ruby">      title: &quot;The Authentic Storyteller&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            
              
            

            <code class="ruby">      description: &quot;You value cinema that speaks to the heart of human experience. Your preference for emotional authenticity combined with appreciation for artistic craft makes you particularly attuned to films that tell genuine stories with creative excellence.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            
              
            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            
              
            

            <code class="ruby">  }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="37">
            
              <span class="hits">1</span>
            

            
              
            

            <code class="ruby">  def self.get_archetype(type_code)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            
              
            

            <code class="ruby">    default = {</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="39">
            
              <span class="hits">22</span>
            

            
              
            

            <code class="ruby">      title: &quot;The Cinematic Explorer&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            
              
            

            <code class="ruby">      description: &quot;Your unique approach to cinema combines multiple perspectives, making you a versatile and nuanced film enthusiast. You appreciate both the technical mastery and emotional depth of great filmmaking, finding your own special way to connect with each story.&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            
              
            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            
              
            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="22" data-linenumber="43">
            
              <span class="hits">22</span>
            

            
              
            

            <code class="ruby">    ARCHETYPES[type_code] || default</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            
              
            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            
              
            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
